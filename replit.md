# Telegram бот для управления пользователями Emby

## Обзор проекта
Этот проект представляет собой Telegram бота для автоматизированного управления пользователями Emby медиа-сервера. Бот позволяет массово создавать пользователей из Excel файлов и автоматически удалять их через 14 дней после первого входа.

## Текущее состояние
- ✅ Python 3.11 установлен
- ✅ Зависимости установлены (python-telegram-bot, openpyxl, requests, apscheduler)
- ✅ Все основные файлы созданы (bot.py, database.py, emby_api.py)
- ✅ Переменные окружения настроены через Replit Secrets
- ✅ Workflow настроен и бот успешно запущен
- ✅ Бот работает и обрабатывает сообщения
- ⚠️ Emby сервер недоступен из облака (требуется публичный URL)

## Архитектура проекта

### Файловая структура
```
EmbyManagerBot/
├── bot.py              # Главный файл с логикой Telegram бота
├── database.py         # Модуль работы с SQLite базой данных
├── emby_api.py         # Модуль интеграции с Emby API
├── README.md           # Документация проекта
├── .gitignore          # Игнорируемые файлы
└── emby_bot.db        # SQLite база (создается автоматически)
```

### Основные компоненты

1. **bot.py** - Telegram бот с следующими функциями:
   - Команды: /start, /add_admin, /remove_admin, /add_admin_group
   - Inline клавиатура для управления
   - Обработка Excel файлов для массового создания пользователей
   - Фоновые задачи проверки входов и удаления пользователей

2. **database.py** - SQLite база данных:
   - Таблица emby_users: пользователи Emby и время их первого входа
   - Таблица admins: администраторы бота
   - Таблица admin_groups: группы для уведомлений

3. **emby_api.py** - Интеграция с Emby:
   - Создание и удаление пользователей
   - Проверка активности пользователей
   - Получение статистики просмотров

### Переменные окружения (Secrets)
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота от @BotFather
- `EMBY_SERVER_URL` - адрес Emby сервера (http://192.168.1.60:8096)
- `EMBY_API_KEY` - API ключ Emby администратора
- `FIRST_ADMIN_ID` - Telegram ID первого администратора

## Функциональность

### Создание пользователей
- Загрузка Excel файлов с колонками 'user' и 'pass'
- Автоматическое создание пользователей в Emby
- Только имена начинающиеся с "user"
- Запись в базу данных для отслеживания

### Автоматическое удаление
- Проверка первых входов каждый час
- Удаление через 14 дней после первого входа
- Уведомления администраторам в ЛС и группы
- Работа в фоновом режиме

### Управление
- Inline клавиатура с кнопками
- Статистика пользователей
- Проверка подключения к Emby
- Управление администраторами

## Последние изменения
- 2025-10-20: Успешная адаптация проекта для Replit
- 2025-10-20: Настройка зависимостей через uv (python-telegram-bot, openpyxl, requests, apscheduler)
- 2025-10-20: Создание основных файлов проекта (bot.py, database.py, emby_api.py)
- 2025-10-20: Настройка Replit Secrets для конфиденциальных данных
- 2025-10-20: Создание workflow "Telegram Bot" для автоматического запуска
- 2025-10-20: Изменена логика запуска - бот теперь работает даже при недоступности Emby
- 2025-10-20: Бот успешно запущен и работает

## Примечания
- Бот работает только с пользователями, чьи имена начинаются с "user"
- Удаление происходит ровно через 14 дней после первого входа
- Требуется доступ к Emby серверу по сети
- **Важно**: Локальный IP адрес (192.168.1.60) недоступен из облака Replit. Для полной работы функций нужен:
  - Публичный URL Emby сервера (через динамический DNS или статический IP)
  - Или туннель (ngrok, cloudflare tunnel)
  - Или VPN подключение
- Бот запускается даже при недоступности Emby и продолжит работу при восстановлении связи
